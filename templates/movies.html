<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×›×œ ×”×¡×¨×˜×™× - ×× ×™××” ×¤×œ×•×¡</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸŒ¸</text></svg>">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/showall.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        .profile-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid #e2e8f0;
        }
        .user-profile a {
            display: flex;
            align-items: center;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <a href="/" style="text-decoration: none; color: inherit;">
                        <span class="logo-icon">ğŸŒ¸</span>
                        <span class="logo-text">×× ×™××”<span class="logo-plus">×¤×œ×•×¡</span></span>
                    </a>
                </div>
                <nav class="nav">
                    <a href="/" class="nav-link">×”×›×œ</a>
                    <a href="/shows" class="nav-link">×¡×“×¨×•×ª</a>
                    <a href="/movies" class="nav-link active">×¡×¨×˜×™×</a>
                    {% if user and user.email == 'ehudverbin@gmail.com' %}
                        <a href="/manage" class="nav-link">× ×™×”×•×œ</a>
                    {% endif %}
                </nav>
                <div class="header-actions">
                    <div class="user-profile">
                        {% if user %}
                            <a href="{{ url_for('logout') }}" title="×”×ª× ×ª×§×•×ª">
                                <img src="{{ user.picture }}" alt="{{ user.name }}" class="profile-pic">
                            </a>
                        {% else %}
                            <a href="{{ url_for('login') }}">
                                <button class="user-btn">ğŸ‘¤</button>
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main>
        <section class="page-header">
            <div class="container">
                <h1>×›×œ ×”×¡×¨×˜×™×</h1>
                <p>××¦××• ××ª ×¡×¨×˜ ×”×× ×™××” ×”×‘× ×©×œ×›× ××ª×•×š ×”××‘×—×¨ ×”×¨×—×‘ ×©×œ× ×•.</p>
            </div>
        </section>

        <div class="container">
            <section class="filters-bar">
                <div class="filter-group search-group">
                    <span class="search-icon">ğŸ”</span>
                    <input type="text" id="searchInput" class="search-input" placeholder="×—×™×¤×•×© ×œ×¤×™ ×©×...">
                </div>
                <div class="filter-group">
                    <label for="genreFilter" class="filter-label">×–'×× ×¨:</label>
                    <select id="genreFilter" class="filter-select">
                        <option value="all">×›×œ ×”×–'×× ×¨×™×</option>
                        <option value="×¤×¢×•×œ×”">×¤×¢×•×œ×”</option>
                        <option value="×”×¨×¤×ª×§××•×ª">×”×¨×¤×ª×§××•×ª</option>
                        <option value="×¨×•×× ×˜×™×§×”">×¨×•×× ×˜×™×§×”</option>
                        <option value="×§×•××“×™×”">×§×•××“×™×”</option>
                        <option value="×¤× ×˜×–×™×”">×¤× ×˜×–×™×”</option>
                        <option value="×“×¨××”">×“×¨××”</option>
                        <option value="××•×ª×—×Ÿ">××•×ª×—×Ÿ</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="ratingFilter" class="filter-label">×“×™×¨×•×’:</label>
                    <select id="ratingFilter" class="filter-select">
                        <option value="0">×”×›×œ</option>
                        <option value="8">8+</option>
                        <option value="7">7+</option>
                        <option value="6">6+</option>
                        <option value="5">5+</option>
                    </select>
                </div>
            </section>

            <section class="content-grid-container">
                <div id="contentGrid" class="anime-grid">
                </div>
                <div id="loading" class="loading">
                    <div class="spinner"></div>
                </div>
            </section>
        </div>
    </main>
    
    <div id="animeModal" class="modal">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <button class="modal-close">âœ•</button>
            <div id="modalBody" class="modal-body">
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>×× ×™××” ×¤×œ×•×¡</h3>
                    <p>×”×¤×œ×˜×¤×•×¨××” ×”××•×‘×™×œ×” ×œ×¦×¤×™×™×” ×‘×× ×™××” ×‘×™×©×¨××œ</p>
                </div>
                <div class="footer-section">
                    <h4>×§×™×©×•×¨×™× ××”×™×¨×™×</h4>
                    <ul>
                        <li><a href="#">××•×“×•×ª</a></li>
                        <li><a href="#">×™×¦×™×¨×ª ×§×©×¨</a></li>
                        <li><a href="#">×ª× ××™ ×©×™××•×©</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>×¢×§×‘×• ××—×¨×™× ×•</h4>
                    <div class="social-links">
                        <a href="#">ğŸ“˜</a>
                        <a href="#">ğŸ“·</a>
                        <a href="#">ğŸ¦</a>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 ×× ×™××” ×¤×œ×•×¡. ×›×œ ×”×–×›×•×™×•×ª ×©××•×¨×•×ª.</p>
            </div>
        </div>
    </footer>

    <script>
        const CONTENT_TYPE = 'movie';
        let currentSearch = '';
        let currentGenre = 'all';
        let currentRating = 0;
        let allContentData = [];

        const contentGrid = document.getElementById('contentGrid');
        const loading = document.getElementById('loading');
        const searchInput = document.getElementById('searchInput');
        const genreFilter = document.getElementById('genreFilter');
        const ratingFilter = document.getElementById('ratingFilter');

        async function fetchData() {
            loading.style.display = 'flex';
            contentGrid.innerHTML = '';
            
            try {
                const url = `/api/anime?type=${CONTENT_TYPE}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network response was not ok');
                allContentData = await response.json();
                applyFiltersAndRender();
            } catch (error) {
                console.error('Failed to fetch data:', error);
                displayMessage("×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×.");
            } finally {
                loading.style.display = 'none';
            }
        }

        function applyFiltersAndRender() {
            let filteredData = allContentData;

            if (currentSearch) {
                filteredData = filteredData.filter(item => 
                    item.title_he.toLowerCase().includes(currentSearch) ||
                    item.title.toLowerCase().includes(currentSearch)
                );
            }

            if (currentGenre !== 'all') {
                filteredData = filteredData.filter(item => item.genre && item.genre.includes(currentGenre));
            }

            if (currentRating > 0) {
                filteredData = filteredData.filter(item => item.rating >= currentRating);
            }
            
            populateGrid(filteredData);
        }
        
        function populateGrid(data) {
            contentGrid.innerHTML = '';
            if (data.length === 0) {
                displayMessage("×œ× × ××¦××• ×¡×¨×˜×™× ×”×ª×•×××™× ××ª ×”×¡×™× ×•×Ÿ ×©×œ×š.");
                return;
            }
            data.forEach(item => {
                const card = createAnimeCard(item);
                contentGrid.appendChild(card);
            });
        }

        function displayMessage(message) {
            contentGrid.innerHTML = `<p class="grid-message">${message}</p>`;
        }
        
        function createAnimeCard(anime) {
            const card = document.createElement('div');
            card.className = 'anime-card';
            card.onclick = () => openModal(anime.id);
            
            card.innerHTML = `
                <div class="anime-image">
                    <img src="${anime.image}" alt="${anime.title_he}" onerror="this.src='https://placehold.co/300x420/cccccc/ffffff?text=Image+Error'">
                    <div class="anime-overlay">
                        <button class="play-btn">â–¶ ×¦×¤×” ×¢×›×©×™×•</button>
                    </div>
                    <span class="anime-type">${anime.type === 'series' ? '×¡×“×¨×”' : '×¡×¨×˜'}</span>
                </div>
                <div class="anime-info">
                    <h3 class="anime-title">${anime.title_he}</h3>
                    <div class="anime-meta">
                        <span class="rating">â­ ${anime.rating}</span>
                        <span class="year">${anime.year}</span>
                    </div>
                </div>
            `;
            return card;
        }
        
        async function openModal(animeId) {
            const modal = document.getElementById('animeModal');
            const modalBody = document.getElementById('modalBody');
            
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            modalBody.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            
            try {
                const response = await fetch(`/api/anime/${animeId}`);
                if (!response.ok) throw new Error('Failed to fetch anime details');
                const anime = await response.json();

                if (!anime) throw new Error('Anime not found');
                
                let watchAction = `window.location.href='/movie/${anime.id}'`;

                modalBody.innerHTML = `
                    <div class="modal-hero">
                        <img src="${anime.banner || anime.image}" alt="${anime.title_he}">
                        <div class="modal-hero-overlay">
                            <h2>${anime.title_he}</h2>
                            <p class="modal-subtitle">${anime.title}</p>
                        </div>
                    </div>
                    <div class="modal-details">
                        <div class="modal-actions">
                            <button class="btn-primary" onclick="${watchAction}">â–¶ ×”×ª×—×œ ×œ×¦×¤×•×ª</button>
                        </div>
                        <div class="modal-info">
                            <div class="info-row">
                                <span class="info-label">×“×™×¨×•×’:</span>
                                <span class="info-value">â­ ${anime.rating}/10</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">×©× ×”:</span>
                                <span class="info-value">${anime.year}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">××©×š:</span>
                                <span class="info-value">${anime.duration ? anime.duration + ' ×“×§×•×ª' : '×œ× ×™×“×•×¢'}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">×–'×× ×¨×™×:</span>
                                <span class="info-value">${(anime.genre || []).join(', ')}</span>
                            </div>
                        </div>
                        <div class="modal-description">
                            <h3>×ª×§×¦×™×¨</h3>
                            <p>${anime.description}</p>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('×©×’×™××” ×‘×˜×¢×™× ×ª ×¤×¨×˜×™ ×× ×™××”:', error);
                modalBody.innerHTML = `<div class="modal-error"><h3>××•×¤×¡!</h3><p>××™×¨×¢×” ×©×’×™××” ×‘×˜×¢×™× ×ª ×¤×¨×˜×™ ×”×× ×™××”. × ×¡×• ×©× ×™×ª ×××•×—×¨ ×™×•×ª×¨.</p></div>`;
            }
        }

        function closeModal() {
            const modal = document.getElementById('animeModal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => { clearTimeout(timeout); func(...args); };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetchData();
        
            searchInput.addEventListener('input', debounce(e => {
                currentSearch = e.target.value.toLowerCase();
                applyFiltersAndRender();
            }, 300));
            
            genreFilter.addEventListener('change', e => {
                currentGenre = e.target.value;
                applyFiltersAndRender();
            });
            
            ratingFilter.addEventListener('change', e => {
                currentRating = parseFloat(e.target.value);
                applyFiltersAndRender();
            });

            document.querySelector('.modal-close').addEventListener('click', closeModal);
            document.querySelector('.modal-overlay').addEventListener('click', closeModal);
        });
    </script>
</body>
</html>
