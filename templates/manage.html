<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ניהול תוכן - אנימה פלוס</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/manage.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>מערכת ניהול תוכן</h1>
            <a href="/" class="back-link">חזרה לאתר הראשי &rarr;</a>
        </header>
        
        <main class="manage-grid">
            <div class="form-section">
                <h2>הוספת תוכן חדש</h2>
                <div class="form-group">
                    <label>סוג התוכן:</label>
                    <div class="radio-group">
                        <input type="radio" id="typeSeries" name="contentType" value="series" checked>
                        <label for="typeSeries">סדרה</label>
                        <input type="radio" id="typeMovie" name="contentType" value="movie">
                        <label for="typeMovie">סרט</label>
                        <input type="radio" id="typeEpisode" name="contentType" value="episode">
                        <label for="typeEpisode">פרק לסדרה קיימת</label>
                    </div>
                </div>

                <div id="add-new-content-area">
                    <div id="category-selection-area">
                        <div class="form-group">
                            <label for="categorySelect">בחירת קטגוריות (Ctrl/Cmd לבחירה מרובה):</label>
                            <select id="categorySelect" multiple>
                                <option value="">טוען קטגוריות...</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="searchInput">חיפוש (שם באנגלית):</label>
                        <div class="search-wrapper">
                            <input type="text" id="searchInput" placeholder="לדוגמה: Attack on Titan">
                            <button id="searchBtn">חפש</button>
                        </div>
                    </div>
                    <div id="searchResults" class="results-section"></div>
                </div>

                <div id="add-episode-area" style="display: none;">
                    <div class="form-group">
                        <label for="existingSeriesSelect">בחירת סדרה קיימת:</label>
                        <select id="existingSeriesSelect"></select>
                    </div>
                    <div id="episode-fields-container"></div>
                    <button id="addEpisodesBtn" class="add-button">הוסף פרקים</button>
                </div>
            </div>

            <div class="form-section span-two">
                <h2>ניהול תוכן קיים</h2>
                <div class="existing-content-filters">
                    <input type="text" id="existingContentSearch" placeholder="חיפוש לפי שם...">
                    <div class="radio-group">
                        <input type="radio" id="filterAll" name="filterType" value="all" checked>
                        <label for="filterAll">הכל</label>
                        <input type="radio" id="filterSeries" name="filterType" value="series">
                        <label for="filterSeries">סדרות</label>
                        <input type="radio" id="filterMovies" name="filterType" value="movie">
                        <label for="filterMovies">סרטים</label>
                    </div>
                </div>
                <div id="existingContentList" class="results-section"></div>
            </div>

            <div class="form-section">
                <h2>ניהול קטגוריות</h2>
                <div class="form-group">
                    <label for="newCategoryName">שם קטגוריה חדשה:</label>
                    <div class="search-wrapper">
                        <input type="text" id="newCategoryName" placeholder="לדוגמה: אקשן, קומדיה...">
                        <button id="createCategoryBtn">צור קטגוריה</button>
                    </div>
                </div>
                <div id="categoryListContainer">
                    <h4>קטגוריות קיימות:</h4>
                    <ul id="categoryList" class="category-list"></ul>
                </div>
            </div>
            
            <div class="form-section">
                <h2>פעולות מערכת</h2>
                <div class="form-group">
                     <button id="updateCacheBtn" class="update-button">עדכן קובץ מידע (Cache)</button>
                </div>
            </div>

            <div class="preview-section" id="previewSection" style="display: none;">
                <h2>תצוגה מקדימה והוספה</h2>
                <div id="previewContent"></div>
                <div id="additionalFields"></div>
                <button id="addBtn" class="add-button">הוסף למסד הנתונים</button>
            </div>
        </main>

        <div id="statusMessage" class="status-message"></div>
    </div>

    <div id="editCategoryModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3>עריכת קטגוריות עבור <span id="modalContentTitle"></span></h3>
            <div class="form-group">
                <label for="modalCategorySelect">בחירת קטגוריות (Ctrl/Cmd לבחירה מרובה):</label>
                <select id="modalCategorySelect" multiple></select>
            </div>
            <button id="saveCategoryChangesBtn" class="add-button">שמור שינויים</button>
        </div>
    </div>

    <script>
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const searchResultsContainer = document.getElementById('searchResults');
        const previewSection = document.getElementById('previewSection');
        const previewContent = document.getElementById('previewContent');
        const additionalFieldsContainer = document.getElementById('additionalFields');
        const addBtn = document.getElementById('addBtn');
        const updateCacheBtn = document.getElementById('updateCacheBtn');
        const statusMessage = document.getElementById('statusMessage');
        const categorySelect = document.getElementById('categorySelect');
        const createCategoryBtn = document.getElementById('createCategoryBtn');
        const newCategoryNameInput = document.getElementById('newCategoryName');
        const categoryList = document.getElementById('categoryList');
        
        const addNewContentArea = document.getElementById('add-new-content-area');
        const addEpisodeArea = document.getElementById('add-episode-area');
        const existingSeriesSelect = document.getElementById('existingSeriesSelect');
        const episodeFieldsContainer = document.getElementById('episode-fields-container');
        const addEpisodesBtn = document.getElementById('addEpisodesBtn');

        const existingContentList = document.getElementById('existingContentList');
        const existingContentSearch = document.getElementById('existingContentSearch');

        const editModal = document.getElementById('editCategoryModal');
        const modalContentTitle = document.getElementById('modalContentTitle');
        const modalCategorySelect = document.getElementById('modalCategorySelect');
        const saveCategoryChangesBtn = document.getElementById('saveCategoryChangesBtn');
        const closeModalBtn = editModal.querySelector('.close-button');

        let selectedItem = null;
        let allExistingContent = [];
        let allCategories = [];
        let currentEditingContentId = null;

        function getSelectedContentType() {
            return document.querySelector('input[name="contentType"]:checked').value;
        }
        
        async function loadCategories() {
            try {
                const response = await fetch('/api/categories');
                allCategories = await response.json();
                
                categorySelect.innerHTML = '';
                modalCategorySelect.innerHTML = '';
                categoryList.innerHTML = '';

                if (allCategories.length === 0) {
                     categoryList.innerHTML = '<li>אין קטגוריות להצגה.</li>';
                }

                allCategories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = cat.name;
                    categorySelect.appendChild(option.cloneNode(true));
                    modalCategorySelect.appendChild(option);

                    const li = document.createElement('li');
                    li.className = 'category-item';
                    li.innerHTML = `
                        <span>${cat.name}</span>
                        <div class="cat-actions">
                            <button class="rename-cat-btn" data-id="${cat.id}" data-name="${cat.name}">שנה שם</button>
                            <button class="delete-cat-btn small" data-id="${cat.id}">מחק</button>
                        </div>
                    `;
                    categoryList.appendChild(li);
                });
            } catch (error) {
                console.error("Failed to load categories:", error);
                categoryList.innerHTML = '<li>שגיאה בטעינת קטגוריות.</li>';
            }
        }

        async function loadExistingSeries() {
            try {
                const response = await fetch('/api/existing_series');
                const series = await response.json();
                existingSeriesSelect.innerHTML = '<option value="">-- בחר סדרה --</option>';
                series.forEach(s => {
                    const option = document.createElement('option');
                    option.value = s.id;
                    option.textContent = s.title_he;
                    existingSeriesSelect.appendChild(option);
                });
            } catch (error) {
                console.error("Failed to load existing series:", error);
            }
        }

        function toggleContentAddMode() {
            const type = getSelectedContentType();
            resetState();
            if (type === 'episode') {
                addNewContentArea.style.display = 'none';
                addEpisodeArea.style.display = 'block';
                loadExistingSeries();
            } else {
                addNewContentArea.style.display = 'block';
                addEpisodeArea.style.display = 'none';
                searchInput.placeholder = type === 'series' ? 'חפש סדרה חדשה' : 'חפש סרט חדש';
            }
        }

        async function handleSearch() {
            const query = searchInput.value.trim();
            if (!query) return;
            const type = getSelectedContentType();
            const searchType = type === 'movie' ? 'movie' : 'tv';
            searchResultsContainer.innerHTML = '<div class="loader"></div>';
            previewSection.style.display = 'none';
            try {
                const response = await fetch(`/api/search_external?query=${encodeURIComponent(query)}&type=${searchType}`);
                if (!response.ok) throw new Error('שגיאה בחיפוש');
                const results = await response.json();
                displaySearchResults(results);
            } catch (error) {
                searchResultsContainer.innerHTML = `<p class="error">${error.message}</p>`;
            }
        }

        function displaySearchResults(results) {
            searchResultsContainer.innerHTML = '';
            if (results.length === 0) {
                searchResultsContainer.innerHTML = '<p>לא נמצאו תוצאות.</p>';
                return;
            }
            results.forEach(item => {
                const resultCard = document.createElement('div');
                resultCard.className = 'result-card';
                resultCard.innerHTML = `<img src="${item.poster || 'https://placehold.co/100x150/333/fff?text=N/A'}" alt="Poster"><div class="result-info"><h4>${item.title} (${item.year})</h4><p>${item.overview ? item.overview.substring(0, 150) + '...' : ''}</p></div>`;
                resultCard.addEventListener('click', () => selectItem(item));
                searchResultsContainer.appendChild(resultCard);
            });
        }

        function selectItem(item) {
            selectedItem = item;
            document.querySelectorAll('.result-card').forEach(card => card.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            previewSection.style.display = 'block';
            previewContent.innerHTML = `<h3>${item.title} (${item.year})</h3><img src="${item.poster || ''}" alt="Poster" style="max-width: 150px; border-radius: 8px;"><p>${item.overview}</p>`;
            additionalFieldsContainer.innerHTML = '';
            if (getSelectedContentType() === 'movie') {
                additionalFieldsContainer.innerHTML = `<div class="form-group"><label for="videoUrlInput">קישור וידאו:</label><input type="url" id="videoUrlInput" placeholder="https://..."></div>`;
            }
        }

        async function handleAdd() {
            if (!selectedItem) return;
            const contentType = getSelectedContentType();
            const categoryIds = Array.from(categorySelect.selectedOptions).map(option => option.value);

            if (contentType !== 'episode' && categoryIds.length === 0) {
                showStatus('חובה לבחור לפחות קטגוריה אחת', 'error');
                return;
            }
            
            const payload = { type: contentType, tmdb_id: selectedItem.id, category_ids: categoryIds };
            if (contentType === 'movie') {
                payload.video_url = document.getElementById('videoUrlInput').value;
            }
            await sendAddRequest(payload);
        }
        
        async function handleAddEpisodes() {
            const series_id = existingSeriesSelect.value;
            if (!series_id) { showStatus('יש לבחור סדרה', 'error'); return; }
            const seasonInput = document.getElementById('seasonInput');
            if (!seasonInput || !seasonInput.value) { showStatus('יש להזין מספר עונה', 'error'); return; }
            const season_num = seasonInput.value;

            const episodeRows = document.querySelectorAll('.episode-row');
            if (episodeRows.length === 0) { showStatus('אין פרקים להוספה', 'info'); return; }

            for (const row of episodeRows) {
                const episodeNumInput = row.querySelector('.episode-number-input');
                const videoUrlInput = row.querySelector('.episode-url-input');

                if (episodeNumInput.value && videoUrlInput.value) {
                     const payload = {
                        type: 'episode',
                        series_id: series_id,
                        season: season_num,
                        episode: episodeNumInput.value,
                        video_url: videoUrlInput.value
                    };
                    try {
                        await sendAddRequest(payload, false);
                        row.style.border = "2px solid #03dac6";
                        showStatus(`פרק ${episodeNumInput.value} נוסף בהצלחה`, 'success');
                    } catch (e) {
                         row.style.border = "2px solid #cf6679";
                         showStatus(`שגיאה בהוספת פרק ${episodeNumInput.value}: ${e.message}`, 'error');
                    }
                }
            }
            showStatus('הוספת הפרקים הסתיימה.', 'info');
        }

        async function sendAddRequest(payload, shouldReset = true) {
            if (shouldReset) {
                 showStatus('מעבד...', 'info');
            }
           
            const response = await fetch('/api/add_content', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            if (!response.ok || !result.success) {
                throw new Error(result.error || 'שגיאה לא ידועה');
            }
            if (shouldReset) {
                showStatus(result.message, 'success');
                resetState();
                loadExistingContent();
            }
        }

        async function loadExistingContent() {
            existingContentList.innerHTML = '<div class="loader"></div>';
            try {
                const response = await fetch('/api/anime?type=all');
                allExistingContent = await response.json();
                renderExistingContent();
            } catch (error) {
                existingContentList.innerHTML = '<p class="error">שגיאה בטעינת תוכן קיים</p>';
            }
        }

        function renderExistingContent() {
            const searchTerm = existingContentSearch.value.toLowerCase();
            const filterType = document.querySelector('input[name="filterType"]:checked').value;
            
            const filteredContent = allExistingContent.filter(item => {
                const titleHe = item.title_he || '';
                const title = item.title || '';
                const matchesSearch = titleHe.toLowerCase().includes(searchTerm) || title.toLowerCase().includes(searchTerm);
                const matchesType = filterType === 'all' || item.type === filterType;
                return matchesSearch && matchesType;
            }).sort((a,b) => (a.title_he || '').localeCompare(b.title_he || ''));

            existingContentList.innerHTML = '';
            if (filteredContent.length === 0) {
                existingContentList.innerHTML = '<p>לא נמצא תוכן תואם.</p>';
                return;
            }

            filteredContent.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'existing-item';
                itemDiv.innerHTML = `
                    <img src="${item.image || 'https://placehold.co/50x75/333/fff?text=N/A'}" alt="Poster">
                    <div class="existing-item-info">
                        <h4>${item.title_he}</h4>
                        <span>${item.type === 'series' ? 'סדרה' : 'סרט'} | ${item.year}</span>
                        <p class="category-tags">קטגוריות: ${(item.categoryNames || []).join(', ') || 'אין'}</p>
                    </div>
                    <div class="existing-item-actions">
                        <button class="rename-content-btn" data-id="${item.id}" data-name="${item.title_he}">שנה שם</button>
                        <button class="edit-cat-btn" data-id="${item.id}">ערוך קטגוריות</button>
                        <button class="delete-content-btn" data-id="${item.id}">מחק</button>
                    </div>
                `;
                existingContentList.appendChild(itemDiv);
            });
        }
        
        async function handleDeleteContent(contentId) {
            if (!confirm('האם אתה בטוח שברצונך למחוק תוכן זה? הפעולה אינה הפיכה.')) return;
            showStatus('מוחק...', 'info');
            try {
                const response = await fetch('/api/delete_content', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content_id: contentId })
                });
                const result = await response.json();
                if (response.ok && result.success) {
                    showStatus(result.message, 'success');
                    loadExistingContent();
                } else { throw new Error(result.error || 'שגיאה במחיקה'); }
            } catch (error) {
                showStatus(`שגיאה: ${error.message}`, 'error');
            }
        }

        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = `status-message ${type} show`;
            setTimeout(() => { statusMessage.classList.remove('show'); }, 4000);
        }
        
        function resetState() {
            searchResultsContainer.innerHTML = '';
            previewSection.style.display = 'none';
            searchInput.value = '';
            episodeFieldsContainer.innerHTML = '';
            if(existingSeriesSelect.options.length > 0) existingSeriesSelect.selectedIndex = 0;
            categorySelect.selectedIndex = -1;
            selectedItem = null;
        }

        function openEditModal(contentId) {
            const item = allExistingContent.find(c => c.id == contentId);
            if (!item) return;
            
            currentEditingContentId = contentId;
            modalContentTitle.textContent = item.title_he;
            
            Array.from(modalCategorySelect.options).forEach(option => {
                option.selected = item.categoryIds && item.categoryIds.includes(option.value);
            });
            
            editModal.style.display = 'block';
        }

        function closeEditModal() {
            editModal.style.display = 'none';
            currentEditingContentId = null;
        }
        
        function addEpisodeRow(episodeNumber = 1) {
            const row = document.createElement('div');
            row.className = 'episode-row';
            row.innerHTML = `
                <div class="form-group episode-number-group">
                    <label>פרק</label>
                    <input type="number" class="episode-number-input" min="1" value="${episodeNumber}">
                </div>
                <div class="form-group episode-url-group">
                    <label>קישור וידאו</label>
                    <input type="url" class="episode-url-input" placeholder="https://...">
                </div>
                <div class="row-actions">
                    <button type="button" class="add-row-btn">+</button>
                    <button type="button" class="remove-row-btn">-</button>
                </div>
            `;
            episodeFieldsContainer.appendChild(row);
        }

        function initializeEpisodeFields() {
            episodeFieldsContainer.innerHTML = `
                <div class="form-group">
                    <label for="seasonInput">מספר עונה:</label>
                    <input type="number" id="seasonInput" min="1" value="1">
                </div>
            `;
            addEpisodeRow();
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadCategories();
            loadExistingContent();

            document.querySelectorAll('input[name="contentType"]').forEach(radio => radio.addEventListener('change', toggleContentAddMode));
            searchBtn.addEventListener('click', handleSearch);
            searchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSearch(); });
            addBtn.addEventListener('click', handleAdd);
            addEpisodesBtn.addEventListener('click', handleAddEpisodes);

            updateCacheBtn.addEventListener('click', async () => {
                showStatus('מעדכן...', 'info');
                const response = await fetch('/api/update_json_cache', { method: 'POST' });
                const result = await response.json();
                showStatus(result.message || result.error, result.success ? 'success' : 'error');
            });

            createCategoryBtn.addEventListener('click', async () => {
                const name = newCategoryNameInput.value.trim();
                if (!name) { showStatus('יש להזין שם לקטגוריה', 'error'); return; }
                const response = await fetch('/api/categories', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name })
                });
                const result = await response.json();
                if (response.ok && result.success) {
                    showStatus(result.message, 'success');
                    newCategoryNameInput.value = '';
                    loadCategories();
                } else { showStatus(result.error || 'שגיאה', 'error'); }
            });
            
            existingSeriesSelect.addEventListener('change', () => {
                if(existingSeriesSelect.value) {
                    initializeEpisodeFields();
                } else {
                    episodeFieldsContainer.innerHTML = '';
                }
            });
            
            episodeFieldsContainer.addEventListener('click', e => {
                if (e.target.classList.contains('add-row-btn')) {
                    const currentRow = e.target.closest('.episode-row');
                    const currentEpisodeNum = currentRow.querySelector('.episode-number-input').value;
                    const nextEpisodeNum = currentEpisodeNum ? parseInt(currentEpisodeNum) + 1 : 1;
                    addEpisodeRow(nextEpisodeNum);
                }
                if (e.target.classList.contains('remove-row-btn')) {
                    if (episodeFieldsContainer.querySelectorAll('.episode-row').length > 1) {
                        e.target.closest('.episode-row').remove();
                    } else {
                        showStatus('לא ניתן להסיר את שורת הפרק האחרונה.', 'info');
                    }
                }
            });

            existingContentSearch.addEventListener('input', renderExistingContent);
            document.querySelectorAll('input[name="filterType"]').forEach(radio => radio.addEventListener('change', renderExistingContent));
            
            existingContentList.addEventListener('click', async (e) => {
                const target = e.target;
                const contentId = target.dataset.id;

                if (target.classList.contains('delete-content-btn')) {
                    handleDeleteContent(contentId);
                }
                if (target.classList.contains('edit-cat-btn')) {
                    openEditModal(contentId);
                }
                if (target.classList.contains('rename-content-btn')) {
                    const currentName = target.dataset.name;
                    const newName = prompt('הזן שם חדש (עברית):', currentName);
                    if (newName && newName.trim() !== '' && newName !== currentName) {
                        const response = await fetch(`/api/content/${contentId}/rename`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ new_title_he: newName.trim() })
                        });
                        const result = await response.json();
                        showStatus(result.message || result.error, response.ok ? 'success' : 'error');
                        if (response.ok) {
                            loadExistingContent();
                        }
                    }
                }
            });

            categoryList.addEventListener('click', async (e) => {
                const target = e.target;
                const id = target.dataset.id;
                if (target.classList.contains('delete-cat-btn')) {
                    if (!confirm('האם אתה בטוח שברצונך למחוק קטגוריה זו? הפעולה תסיר את הקטגוריה מכל הסרטים/סדרות המשויכים אליה.')) return;
                    const response = await fetch(`/api/categories/${id}`, { method: 'DELETE' });
                    const result = await response.json();
                    showStatus(result.message || result.error, response.ok ? 'success' : 'error');
                    if (response.ok) {
                        loadCategories();
                        loadExistingContent();
                    }
                }
                if (target.classList.contains('rename-cat-btn')) {
                    const currentName = target.dataset.name;
                    const newName = prompt('הזן שם חדש לקטגוריה:', currentName);
                    if (newName && newName.trim() !== '' && newName !== currentName) {
                         const response = await fetch(`/api/categories/${id}`, { 
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ name: newName.trim() })
                        });
                        const result = await response.json();
                        showStatus(result.message || result.error, response.ok ? 'success' : 'error');
                        if (response.ok) {
                            loadCategories();
                            loadExistingContent();
                        }
                    }
                }
            });

            closeModalBtn.addEventListener('click', closeEditModal);
            saveCategoryChangesBtn.addEventListener('click', async () => {
                const selectedIds = Array.from(modalCategorySelect.selectedOptions).map(opt => opt.value);
                const response = await fetch(`/api/content/${currentEditingContentId}/categories`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ category_ids: selectedIds })
                });
                const result = await response.json();
                showStatus(result.message || result.error, response.ok ? 'success' : 'error');
                if (response.ok) {
                    closeEditModal();
                    loadExistingContent();
                }
            });
            window.addEventListener('click', (e) => {
                if (e.target == editModal) {
                    closeEditModal();
                }
            });
        });
    </script>
</body>
</html>
